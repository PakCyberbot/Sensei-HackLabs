#!/bin/bash
read -s -p "Enter your password: " password

sudo -v -S <<< "$password"
 
# Don't run it with root just need password for installing binaries
if [ "$(id -u)" -eq 0 ]; then
    echo "This script should not be run as root."
    exit 1
fi

# Check the bash/zsh environment settings
cp .myterm_settings "$HOME/"

current_shell=$(basename "$SHELL")
config_file="$HOME/.$current_shell"rc

if grep -q "source $HOME/.myterm_settings" "$config_file"; then
    echo "No need to make changes in $config_file"
else
    echo "source $HOME/.myterm_settings" >> $config_file
fi
source "$HOME/.myterm_settings"


# Create missing directories
if [ ! -d "$HOME/CTF" ]; then
    mkdir "$HOME/CTF"
fi
cp startPentest.sh "$HOME/CTF"

if [ ! -w "/opt" ]; then
    echo "You don't have permission to write on $directory"
    sudo chmod o+w /opt
else
    echo "You have permission to access $directory"
fi

if [ ! -d "/opt/transfers" ]; then
    mkdir "/opt/transfers"
fi
cp -r transfers "/opt/transfers"

if [ ! -d "/opt/bin" ]; then
    mkdir "/opt/bin"
fi

if [ ! -d "$HOME/Pictures/in_use" ]; then
    mkdir "$HOME/Pictures/in_use"
fi
cp -r in_use "$HOME/Pictures/in_use"


# Checks if required binaries installed
if command -v terminator &> /dev/null; then
    echo "Terminator installed already."
else
    echo "Installing Terminator Now..."
    sudo apt install terminator
fi

if [ ! -d "/home/kali/.config/terminator/" ]; then
    mkdir -p "/home/kali/.config/terminator/"
fi

cp config "$HOME/.config/terminator/config"

if command -v marktext &> /dev/null; then
    echo "marktext installed already."
else
    echo "Installing MarkText Now..."
    download_url=$(curl -s "https://api.github.com/repos/marktext/marktext/releases/latest" | grep -e "browser_download.*AppImage" | cut -d '"' -f 4)
    
    if [ -n "$download_url" ]; then
        # Download the asset using curl
        curl -L -o "marktext" "$download_url"   
        mv marktext /opt/bin
        chmod +x /opt/bin/marktext
        echo "Downloaded the latest release."
    else
        echo "Could not find the latest release or asset."
    fi
    sudo apt install terminator
fi



#Message
cat << EOF > result
[green]The setup of the pentesting CTF environment has been successfully completed.[/green]
New files added during the setup
[blue]└─ /opt/transfers
└─ /opt/bin/marktext
└─ terminator installed
└─ $HOME/.config/terminator/config
└─ $HOME/CTF/startPentest.sh[/blue]
[green]To set up the environment for each pentesting CTF room/box, execute the startPentest.sh script located in $HOME/CTF/.[/green]
EOF